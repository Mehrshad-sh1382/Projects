
import hashlib
import requests
import os
import json
from datetime import datetime

class MalwareHashChecker:
    def __init__(self, virustotal_api_key):
        self.vt_api_key = virustotal_api_key
        self.vt_url = "https://www.virustotal.com/api/v3/files/"

    def calculate_file_hash(self, filepath, algorithm='sha256'):
        if not os.path.exists(filepath):
            raise FileNotFoundError(f"File not found: {filepath}")

        if algorithm == 'md5':
            hasher = hashlib.md5()
        elif algorithm == 'sha1':
            hasher = hashlib.sha1()
        elif algorithm == 'sha256':
            hasher = hashlib.sha256()
        else:
            raise ValueError("Unsupported algorithm. Use: md5, sha1, or sha256")

        with open(filepath, 'rb') as f:
            while chunk := f.read(8192):
                hasher.update(chunk)

        return hasher.hexdigest()

    def check_virustotal(self, file_hash):
        headers = {"x-apikey": self.vt_api_key}

        try:
            response = requests.get(f"{self.vt_url}{file_hash}", headers=headers, timeout=30)
            if response.status_code == 200:
                return self._parse_vt_response(response.json())
            elif response.status_code == 404:
                return {"status": "not_found", "message": "File hash not found in VirusTotal database", "is_malicious": None}
            elif response.status_code == 401:
                return {"status": "error", "message": "Invalid API key", "is_malicious": None}
            else:
                return {"status": "error", "message": f"API error: {response.status_code}", "is_malicious": None}
        except requests.exceptions.RequestException as e:
            return {"status": "error", "message": f"Network error: {str(e)}", "is_malicious": None}

    def _parse_vt_response(self, data):
        try:
            stats = data['data']['attributes']['last_analysis_stats']
            results = data['data']['attributes']['last_analysis_results']

            total_engines = sum(stats.values())
            malicious = stats.get('malicious', 0)
            suspicious = stats.get('suspicious', 0)
            is_malicious = malicious > 0 or suspicious > 3

            detections = []
            for engine, result in results.items():
                if result['category'] in ['malicious', 'suspicious']:
                    detections.append({'engine': engine, 'result': result.get('result', 'Unknown'), 'category': result['category']})

            return {
                "status": "found",
                "is_malicious": is_malicious,
                "total_engines": total_engines,
                "malicious_count": malicious,
                "suspicious_count": suspicious,
                "undetected_count": stats.get('undetected', 0),
                "detections": detections[:10],
                "scan_date": data['data']['attributes'].get('last_analysis_date'),
                "reputation": data['data']['attributes'].get('reputation', 0)
            }
        except KeyError as e:
            return {"status": "error", "message": f"Error parsing response: {str(e)}", "is_malicious": None}

    def scan_file(self, filepath):
        print(f"Scanning file: {filepath}")
        print("-" * 50)

        print("Calculating file hashes...")
        try:
            md5_hash = self.calculate_file_hash(filepath, 'md5')
            sha1_hash = self.calculate_file_hash(filepath, 'sha1')
            sha256_hash = self.calculate_file_hash(filepath, 'sha256')

            print(f"MD5:    {md5_hash}")
            print(f"SHA1:   {sha1_hash}")
            print(f"SHA256: {sha256_hash}")
            print("-" * 50)
        except Exception as e:
            return {"error": f"Failed to calculate hash: {str(e)}", "is_malicious": None}

        print("Checking VirusTotal database...")
        vt_results = self.check_virustotal(sha256_hash)

        results = {
            "filepath": filepath,
            "filesize": os.path.getsize(filepath),
            "hashes": {"md5": md5_hash, "sha1": sha1_hash, "sha256": sha256_hash},
            "virustotal": vt_results,
            "scan_timestamp": datetime.now().isoformat()
        }

        return results

    def print_results(self, results):
        print("\n" + "=" * 50)
        print("SCAN RESULTS")
        print("=" * 50)

        if "error" in results:
            print(f"ERROR: {results['error']}")
            return

        print(f"File: {results['filepath']}")
        print(f"Size: {results['filesize']} bytes")
        print(f"Scan Time: {results['scan_timestamp']}")
        print("-" * 50)

        vt = results['virustotal']

        if vt['status'] == 'found':
            print("\nüîç VirusTotal Results:")
            print(f"Status: {'‚ö†Ô∏è  MALICIOUS' if vt['is_malicious'] else '‚úÖ CLEAN'}")
            print(f"Detection Rate: {vt['malicious_count']}/{vt['total_engines']}")
            print(f"Malicious: {vt['malicious_count']}")
            print(f"Suspicious: {vt['suspicious_count']}")
            print(f"Undetected: {vt['undetected_count']}")
            print(f"Reputation Score: {vt['reputation']}")

            if vt['detections']:
                print("\nTop Detections:")
                for det in vt['detections']:
                    print(f"  - {det['engine']}: {det['result']} ({det['category']})")
        elif vt['status'] == 'not_found':
            print("\nüîç VirusTotal Results:")
            print("Status: ‚ÑπÔ∏è  NOT FOUND (File not in database)")
            print("This could mean the file is new or rare.")
        else:
            print(f"\n‚ùå VirusTotal Error: {vt['message']}")

        print("\n" + "=" * 50)


if __name__ == "__main__":
    API_KEY = "YOUR_VIRUSTOTAL_API_KEY_HERE"
    checker = MalwareHashChecker(API_KEY)
    file_to_scan = "suspicious_file.exe"

    try:
        results = checker.scan_file(file_to_scan)
        checker.print_results(results)

        with open("scan_results.json", "w") as f:
            json.dump(results, f, indent=4)
        print("\nResults saved to scan_results.json")
    except FileNotFoundError:
        print(f"Error: File '{file_to_scan}' not found!")
    except Exception as e:
        print(f"Error: {str(e)}")
